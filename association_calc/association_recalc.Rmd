---
title: "Untitled"
output: html_document
date: "2023-04-08"
---

```{R}

library(ggplot2)

library(readr)

library(dplyr)

library(tidyverse)

library(reshape2)

getmode <- function(codes){
  which.max(tabulate(codes))
}

library(utils)

library(raster)

library(Hmisc)

library(diagis)

```




```{R}

regionalplt <- read.csv('') ## plot information with grid information.

names(regionalplt)

```

```{R}

trees <- read.csv('') ## tree occurrence information within each forest plot.


```

```{R}

names(trees)

```

```{R}

summary(treeds$meanarea)

```
## Extract grids with unique names. Will be used as distinct groups.

```{R}

gridlist <- unique(regionalplt$random)

```
### For example...

```{R}

subplt <- regionalplt %>%
  filter(random == 1151003)

subplt


subtrees <- trees %>%
  filter(plotid %in% unique(subplt$plotid))


subtrees

```



```{R}


tsub <- dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length,value.var = 'spcd') ### Convert the grid level dataset as a plot~species checklist.

tsub

pid <- tsub$plotid
sid <- tsub$plotid

tsub <- tsub %>%
  column_to_rownames(var = 'plotid')

tsub



```
```{R}



#tsub <- tsub[,colSums(tsub != 0)>0]
#tsub <- tsub[, sapply(tsub, function(col) length(unique(col))) > 2]

ncol(tsub)

```
### DO NOT NEED TO RUN THE FOLLOWING CHUNK

```{R}

library(ppcor)
ss <- c()

nn <- c()

zz <- c()

#tsub <- tsub %>%
 # sample_n(size = 100)

tsub <- tsub[rowSums(tsub[])>0,]
tsub <- tsub[,colSums(tsub != 0)>0]

for(i in 1:(ncol(tsub)-1)){
  for(j in (i+1):ncol(tsub)){
    suba <- tsub[,c(i,j)]
    
    scaler <- log1p(sum(suba[,1]*suba[,2]))
    subb <- suba[rowSums(suba[])>0,]
    #subb <- suba[suba[,1]*suba[,2]>0,]
    #suba <- suba[suba$scaler>0,]
    
    if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){
      #print(1)
      #if(cor.test(suba[,c(1,2)])$)
      ktest <- cor.test(subb[,1], subb[,2])
      print(ktest$p.value)
      #if(ktest$p.value<0.05){
      k <- cor(subb[,c(1,2)])[1,2]*scaler
      #k <- k/abs(k)
      m <- cor(suba[,c(1,2)])[1,2]
      #}
      #else{
      #  k <- 0
      #  m <- 0
      #}
      #k <- sum(k)
      #l <- sum(suba$scaler)
      l <- suba$scaler
      
      #m <- sum(suba$scaler)
      sid <- cbind(sid, suba$scaler)
      pid <- cbind(pid,k)
      ss <- append(ss,k)
      nn <- append(nn,l)
      zz <- append(zz,m)
    }
    #else{
    #  k <- 0
    #  l <- sum(suba$scaler)
      
    #  ss[length(ss)+1] <- k
    #  nn[length(nn)+1] <- l
    #}
  }
}
"pid <- as.data.frame(pid)

if(ncol(pid) ==2){
  mean(pid[,2])
}
if(ncol(pid) > 2){
rowspid <- rowSums(pid[,2:ncol(pid)])
print(mean(rowspid))
rowssid <- rowSums(sid[,2:ncol(sid)])

print(sum(rowspid)/sum(rowssid))
#rowspid <- apply(pid[,2:ncol(pid)], 1, function(x) median(x, na.rm = T))

print(mean(rowspid, na.rm = T))
print(std.error(rowspid, na.rm = T))




}
"

#sqrt(weighted_se(ss/nn,nn,na.rm = T))

sum(ss)/length(nn[nn>0])

sum(ss)
mean(zz)
sum(zz)
mean(ss)

length(ss[ss<0])/length(ss)

suppressWarnings({(sum(pcor(tsub)$estimate) - ncol(tsub))/(ncol(tsub) * (ncol(tsub)-1))})

```

```{R}
thred <- 180

```


Initialize the functions that will be leveraged to calculate each features in each grid. 

```{R}

assosimplefun <- function(tsub){

  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

for(i in 1:(ncol(tsub)-1)){
  for(j in (i+1):ncol(tsub)){
    suba <- tsub[,c(i,j)]
    
    scaler <- log1p(sum(suba[,1])*sum(suba[,2])) # summing up grid cell level abundance and use the logged value as the weigh. 
    subb <- suba[rowSums(suba[])>0,] # remove the pairs with double zero. 
    if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){ # there must be at least 3 levels of value. 
      
      k <- cor(subb[,c(1,2)])[1,2]
      ss <- append(ss,k) # a list of correlations is created.
      
    }
    
  }
}

  
  if(length(ss)>0 ){
    return(mean(ss)) # The mean of the regional will be returned. 
  }
  else{
    return(-999)
  }
  }
  }


```


```{R}

assosimplespearfun <- function(tsub){

  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

  #print(unique(df$random))
for(i in 1:(ncol(tsub)-1)){
  for(j in (i+1):ncol(tsub)){
    suba <- tsub[,c(i,j)]
    
    scaler <- log1p(sum(suba[,1])*sum(suba[,2])) # sum up grid cell level abundance and use the logged value as the weigh. 

    subb <- suba[rowSums(suba[])>0,] # remove the pairs with double zero. 
    #suba <- suba[suba$scaler>0,]
    if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){ # there must be at least 3 levels of abundance in both species. 
      
      
      
      #if(ktest$p.value < 0.05){ 
      k <- cor(subb[,c(1,2)],method = 'spearman')[1,2]
      ss <- append(ss,k) # a list of correlations is created.
      
    }
    
  }
}

  
  if(length(ss)>0 ){
    return(mean(ss)) # The mean of the regional will be returned. 
  }
  else{
    return(-999)
  }
  }
  }


```




```{R}

calcassociationsimple <- function(df) {
  
  if(nrow(df)<3){
    return(-999)
  }
  else {
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  
  if(nrow(tsub)<=thred){
    return(assosimplefun(tsub))
  } else{
    alllist <- c()
    for (i in 1:10) {
      set.seed(i)
      subt <- tsub %>%
        sample_n(size = thred)
      subt <- subt[rowSums(subt[])>0,]
      subt <- subt[,colSums(subt != 0)>0]
      
      asso <- assosimplefun(subt)
      alllist <- append(alllist, asso)
      
      
    }
    alllist <- alllist[alllist > -888]
      return(mean(alllist))
  }
  
  }
}


```


```{R}

calcassociationsimplespear <- function(df) {
  
  if(nrow(df)<3){
    return(-999)
  }
  else {
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  
  if(nrow(tsub)<=thred){
    return(assosimplespearfun(tsub))
  } else{
    alllist <- c()
    for (i in 1:10) {
      set.seed(i)
      subt <- tsub %>%
        sample_n(size = thred)
      subt <- subt[rowSums(subt[])>0,]
      subt <- subt[,colSums(subt != 0)>0]
      
      asso <- assosimplespearfun(subt)
      alllist <- append(alllist, asso)
      
      
    }
    alllist <- alllist[alllist > -888]
      return(mean(alllist))
  }
  
  }
}


```

```{R}

partialfun <- function(tsub){
  if(!is.null(ncol(tsub))){
  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  tsub <- tsub[,colSums(tsub != 0)>0]
  tsub <- tsub[rowSums(tsub[])>0,]
  if(nrow(tsub) > 2){
    if(det(cov(tsub))<1e-6){
      return(0)
    }else{
  suppressWarnings({cormatrix <- ppcor::pcor(tsub)$estimate # get the partial correlation matrix
  
  lowtriangle <- sum(cormatrix)-ncol(tsub) # get the sum of the lower triangle
  meanpartial <- lowtriangle/(ncol(tsub) * (ncol(tsub)-1)) # get the mean

  return(meanpartial)})}
  }else{
    return(-999)
  }
  }}
  else(return(-999))
}

```



```{R}
library(ppcor)
library(knitr)

calcassociationpartial <- function(df) {
  #print(unique(df$random))
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  
  #tsub <- tsub[, sapply(tsub, function(col) length(unique(col))) > 1]
  if(ncol(tsub)>=2){
  #tsub <- tsub[, sapply(tsub, function(col) length(unique(col))) > 2]
    tsub <- tsub[rowSums(tsub[])>0,]
  
    return(partialfun(tsub))
  }else{
    return(-999)
  }
  
  }
  
  }

```



```{R}

pvaluefun <- function(tsub){
  
  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

  
  
  for(i in 1:(ncol(tsub)-1)){
    for(j in (i+1):ncol(tsub)){
      suba <- tsub[,c(i,j)]
    
      scaler <- log1p(sum(suba[,1])*sum(suba[,2])) # summing up grid cell level abundance and use the logged value as the weigh. 
      #subb <- suba[suba[,1]*suba[,2]>0,]
      subb <- suba[rowSums(suba[])>0,] # remove the pairs with double zero. 
      #suba <- suba[suba$scaler>0,]
      if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){ # there must be at least 3 levels of value. 
      
        k <- cor(subb[,c(1,2)])[1,2]
        ss <- append(ss,k) # a list of correlations is created. 
     
    }
  
  }
}
        return(ss)
  }
}

```


```{R}

sigfun <- function(tsub){
  
  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

  #print(unique(df$random))
  
  for(i in 1:(ncol(tsub)-1)){
    for(j in (i+1):ncol(tsub)){
      suba <- tsub[,c(i,j)]
    
      scaler <- log1p(sum(suba[,1])*sum(suba[,2])) # summing up grid cell level abundance and use the logged value as the weigh. 
      
      subb <- suba[rowSums(suba[])>0,] # remove the pairs with double zero. 
      if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){ # there must be at least 3 levels of value. 
      
        k <- cor.test(subb[,1], subb[,2])$p.value
        ss <- append(ss,k) # a list of correlations is created. 
     
    }
  
  }
}
        return(ss)
  }
}

```


```{R}

sigfunspear <- function(tsub){
  
  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

  #print(unique(df$random))
  
  for(i in 1:(ncol(tsub)-1)){
    for(j in (i+1):ncol(tsub)){
      suba <- tsub[,c(i,j)]
    
      scaler <- log1p(sum(suba[,1])*sum(suba[,2])) # summing up grid cell level abundance and use the logged value as the weigh. 
      
      subb <- suba[rowSums(suba[])>0,] # remove the pairs with double zero. 
      
      if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){ # there must be at least 3 levels of value. 
      
        k <- cor.test(subb[,1], subb[,2], method = 'spearman', exact = F)$p.value
        ss <- append(ss,k) # a list of correlations is created. 
     
    }
  
  }
}
        return(ss)
  }
}

```


```{R}


assop <- function(df) {
  #print(unique(df$random))
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(nrow(tsub)<=thred){
  
  ss <- sigfun(tsub)
  ss <- ss[ss>=0]
  if(length(ss)>2){
  return(length(ss[ss<0.05])/length(ss))
  }else{
    return(999)
  }
  }
  if(nrow(tsub)>thred){
    
    allp <- c()
    for(i in 1:10){
      set.seed(i)
      subt <- tsub %>%
        sample_n(size = thred)
      ss <- sigfun(subt)
      ss <- ss[ss>=0]
      if(length(ss)>2){
      allp <- append(allp,length(ss[ss<0.05])/length(ss))
      }else{
        allp <- append(allp,999)
      }
    }
    #ss <- as.data.frame(ss)
    allp <- allp[allp<=1]
    return(mean(allp))
  }
  }}


```

```{R}


assopspear <- function(df) {
  #print(unique(df$random))
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(nrow(tsub)<=thred){
  
  ss <- sigfunspear(tsub)
  ss <- ss[ss>=0]
  if(length(ss)>2){
  return(length(ss[ss<0.05])/length(ss))
  }else{
    return(999)
  }
  }
  if(nrow(tsub)>thred){
    
    allp <- c()
    for(i in 1:10){
      set.seed(i)
      subt <- tsub %>%
        sample_n(size = thred)
      ss <- sigfunspear(subt)
      ss <- ss[ss>=0]
      if(length(ss)>2){
      allp <- append(allp,length(ss[ss<0.05])/length(ss))
      }else{
        allp <- append(allp,999)
      }
    }
    
    allp <- allp[allp<=1]
    return(mean(allp))
  }
  }}


```


```{R}


calcassociationnormpvalue <- function(df) {
  
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(nrow(tsub)<=thred){
  
  ss <- pvaluefun(tsub)
  ss <- ss[ss>=0]
  if(length(ss)>2){
  return(shapiro.test(ss)$p.value)
  }else{
    return(999)
  }
  }
  if(nrow(tsub)>thred){
    
    allp <- c()
    for(i in 1:10){
      set.seed(i)
      subt <- tsub %>%
        sample_n(size = thred)
      ss <- pvaluefun(subt)
      ss <- ss[ss>-555]
      if(length(ss)>2){
      allp <- append(allp,shapiro.test(ss)$p.value)
      }else{
        allp <- append(allp,999)
      }
    }
    
    allp <- allp[allp<=1]
    return(mean(allp))
  }
  }}


```



```{R}


calcassociationpvalue <- function(df) {
  
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(nrow(tsub)<=thred){
  
  ss <- pvaluefun(tsub)
  ss <- ss[ss>-555]
  if(length(ss)>2){
    if(sd(ss) == 0){
      return(1)
    }else{
  return(t.test(ss)$p.value)
    }
  }else{
    return(999)
  }
  }
  if(nrow(tsub)>thred){
    
    allp <- c()
    for(i in 1:10){
      set.seed(i)
      subt <- tsub %>%
        sample_n(size = thred)
      ss <- pvaluefun(subt)
      ss <- ss[ss>-555]
      if(length(ss)>2){
        if(sd(ss) == 0){
          allp <- append(allp,1)
        }else{
      allp <- append(allp,t.test(ss)$p.value)
        }
      }else{
        allp <- append(allp,999)
      }
    }
    #ss <- as.data.frame(ss)
    allp <- allp[allp<=1]
    return(mean(allp))
  }
  }}


```




```{R}

calcassociation <- function(df) {
  
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

  #print(unique(df$random))
for(i in 1:(ncol(tsub)-1)){
  for(j in (i+1):ncol(tsub)){
    suba <- tsub[,c(i,j)]
    
    suba$scaler <- log1p(suba[,1]*suba[,2])
    
    subb <- suba[rowSums(suba[])>0,]
    
    if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){
      
      ktest <- cor.test(subb[,1],subb[,2])
      
      if(ktest$p.value < 0.05){
      k <- cor(subb[,c(1,2)])[1,2]*(suba$scaler)}
      else{
        k <- 0*suba$scaler
      }
      #l <- sum(suba$scaler)
      l <- suba$scaler
      
      m <- sum(suba$scaler)
      #}
      #else{
      #  k = 0
      #  l <- suba$scaler
      #}
      
      ss <- append(ss,k)
      nn <- append(nn,l)
      pid <- cbind(pid,k)
    }
    #else{
    #  k <- 0
    #  l <- sum(suba$scaler)
      
    #  ss[length(ss)+1] <- k
    #  nn[length(nn)+1] <- l
    #}
  }
}

  
  if(length(ss)>0 & sum(ss)!=0){
    pid <- as.data.frame(pid)
    if(ncol(pid)>2){
    rowspid <- rowSums(pid[,2:ncol(pid)])
    return(mean(rowspid))
    }
    if(ncol(pid) == 2){
      return(mean(pid[,2]))
    }
    if(ncol(pid) < 2){
      return(-999)
    }
  #return(sum(ss)/length(nn[nn>0]))
  }
  else{
    return(-999)
  }
  }
  }
}


```


```{R}

calcassociation2 <- function(df) {
  
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  sid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

  #print(unique(df$random))
for(i in 1:(ncol(tsub)-1)){
  for(j in (i+1):ncol(tsub)){
    suba <- tsub[,c(i,j)]
    
    suba$scaler <- log1p(suba[,1]*suba[,2])
    #subb <- suba[suba[,1]*suba[,2]>0,]
    subb <- suba[rowSums(suba[])>0,]
    #suba <- suba[suba$scaler>0,]
    if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){
      ktest <- cor.test(subb[,1],subb[,2])
     if(ktest$p.value < 0.05){
      
      k <- cor(subb[,c(1,2)])[1,2]*(suba$scaler)}
      #}
      #else{
      #  k = 0
      #}
      #l <- sum(suba$scaler)
      l <- suba$scaler
      
      m <- sum(suba$scaler)
      
      ss <- append(ss,k)
      nn <- append(nn,l)
      pid <- cbind(pid,k)
      sid <- cbind(sid,suba$scaler)
    }
    
  }
}

  

    pid <- as.data.frame(pid)
    if(ncol(pid)>2){
      rowspid <- rowSums(pid[,2:ncol(pid)])
      #rowssid <- rowSums(sid[,2:ncol(sid)])
      #return(sum(rowspid)/sum(rowssid))
    rowspid <- apply(pid[,2:ncol(pid)], 1, function(x) median(x))
    return(mean(rowspid, na.rm = T))
    }
    if(ncol(pid) == 2){
      return(mean(pid[,2]))
    }
    if(ncol(pid) < 2){
      return(-999)
    }
  #return(sum(ss)/length(nn[nn>0]))
  }

  }
  }



```


```{R}
associationnegprop <- function(df){
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')

  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(ncol(tsub)<2){
    return(-888)
  }
  else{
  
  tsub <- tsub[,colSums(tsub != 0)>0]
  
  ss <- c()
  nn <- c()

  #print(unique(df$random))
for(i in 1:(ncol(tsub)-1)){
  for(j in (i+1):ncol(tsub)){
    suba <- tsub[,c(i,j)]
    
    suba$scaler <- log1p(suba[,1]*suba[,2])
    
    subb <- suba[rowSums(suba[])>0,]
    if(length(unique(subb[,1]))>2 & length(unique(subb[,2]))>2){
      
      ktest <- cor.test(subb[,1],subb[,2])
      if(ktest$p.value<0.05){
      k <- cor(subb[,c(1,2)])[1,2]}
      else{
        k <- 0
      }
      
      l <- suba$scaler
      
      m <- sum(suba$scaler)
      
      ss <- append(ss,k)
      nn <- append(nn,l)
      
    }
    
  }
}

  
  if(length(ss)>0 & sum(ss)!=0){
  return(length(ss[ss<0])/length(ss))
  }
  else{
    return(-999)
  }
  }
  }
  
}

```



```{r}
library(plotrix)

associationsr <- function(df) {
  #print(unique(df$random))
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(nrow(tsub)<=thred){
    ss <- pvaluefun(tsub)
    ss <- ss[ss>-555]
    if(length(ss)>2){
      return(std.error(ss))
    }else{
      return(-999)
    }
  }else{
  allsr <- c()
  for(i in 1:10){
    set.seed(i)
    subt <- tsub %>%
      sample_n(size = thred)
    ss <- pvaluefun(subt)
    if(length(ss)>2){
      allsr <- append(allsr,std.error(ss))
    }else{
     allsr <- append(allsr, -999)
    }
  }
  allsr <- allsr[allsr>-999]
  
  if(length(allsr)>0){
    return(median(allsr))
  }else{
    return(-999)
  }
}
  
 
  }
}

```
```{r}
library(plotrix)

associationspearsr <- function(df) {
  #print(unique(df$random))
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')
  pid <- tsub$plotid
  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  
  if(nrow(tsub)<=thred){
    ss <- assosimplespearfun(tsub)
    ss <- ss[ss>-555]
    if(length(ss)>2){
      return(std.error(ss))
    }else{
      return(-999)
    }
  }else{
  allsr <- c()
  for(i in 1:10){
    set.seed(i)
    subt <- tsub %>%
      sample_n(size = thred)
    ss <- assosimplespearfun(subt)
    if(length(ss)>2){
      allsr <- append(allsr,std.error(ss))
    }else{
     allsr <- append(allsr, -999)
    }
  }
  allsr <- allsr[allsr>-999]
  
  if(length(allsr)>0){
    return(median(allsr))
  }else{
    return(-999)
  }
}
  
 
  }
}

```



```{R}

richfun <- function(tsub){
  
  if(!is.null(ncol(tsub))){
  
  if (ncol(tsub)<1) {
    return(-888)
  }else{
    return(ncol(tsub))
  }
  }else{
    return(-999)
  }
}

```




```{r}
regionalrichness <- function(df) {
  #print(unique(df$random))
  if(nrow(df)<3){
    return(-999)
  }
  else{
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  tsub <- reshape2::dcast(subtrees[,c('spcd', 'plotid')], plotid~spcd, length, value.var = 'spcd')

  tsub <- tsub %>%
  column_to_rownames(var = 'plotid')
  if(ncol(tsub) == 1){
    return(1)
  }else{
  tsub <- tsub[rowSums(tsub[])>0,]
  tsub <- tsub[,colSums(tsub != 0) > 0]
  
  
  if(nrow(tsub)<=thred){
    return(richfun(tsub))
  }else{
    alllist <- c()
    for (i in 1:10) {
      set.seed(i)
      subt <- tsub %>%
        sample_n(size = thred)
      subt <- subt[rowSums(subt[])>0,]
      subt <- subt[,colSums(subt != 0) > 0]
      rich <- richfun(subt)
      alllist <- append(alllist, rich)
    }
    alllist <- alllist[alllist>-555]
    return(mean(alllist))
  }}
  
  
  
  }
  
}

```

```{R}

regionaldensity <- function(df){
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  plotleveldf <- subtrees %>%
    group_by(plotid) %>%
    dplyr::summarise(
      totaldensity = sum(tph)
    ) %>%
    ungroup()
  
  return(mean(plotleveldf$totaldensity))
}


```


```{r}

regionaldensitysr <- function(df){
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  
  plotleveldf <- subtrees %>%
    group_by(plotid) %>%
    dplyr::summarise(
      totaldensity = sum(tph)
    ) %>%
    ungroup()
  
  return(mean(plotleveldf$totaldensity))
}

```

```{R}
library(rlang)

regionalmean <- function(df, variable){
  varname = substitute(variable)
  if(nrow(df)<3){
    return(-99999)
  } else if(nrow(df)<thred) {
    bb <- get(variable, df)
    return(mean(bb))
  }else{
    alllist <- c()
    for(i in 1:10){
      set.seed(i)
      subdf <- df %>%
        sample_n(size = thred)
      bb <- get(variable, df)
      ss <- mean(bb)
      alllist <- append(alllist,ss)
    }
    return(mean(alllist))
  }
    
}


regionalstd <- function(df, variable){
  if(nrow(df)<3){
    return(-99999)
  } else if(nrow(df)<thred) {
    bb <- get(variable, df)
    return(sd(bb))
  }else{
    alllist <- c()
    for(i in 1:10){
      set.seed(i)
      subdf <- df %>%
        sample_n(size = thred)
      bb <- get(variable, df)
      ss <- sd(bb)
      alllist <- append(alllist,ss)
    }
    return(mean(alllist))
  }
    
}





```
```{r}
standba <- function(df){
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  subtrees <- subtrees %>%
    dplyr::mutate(
      baindi = (dbh*dbh*tph)/(40000*pi)
    )
  plotdf <- subtrees %>%
    group_by(plotid)%>%
    dplyr::summarise(
      totalba = sum(baindi)
    )%>%
    ungroup()
  
  return(mean(plotdf$totalba))
  
  }


```

```{r}
regionalba <- function(df) {
  #print(unique(df$random))
  if(nrow(df)<3){
    return(-999)
  }
  else{
    
    if(nrow(df)<=thred){
      return(standba(df))
  }else{
    alllist <- c()
    for (i in 1:10) {
      set.seed(i)
      subt <- df %>%
        sample_n(size = thred)
      #subt <- subt[rowSums(subt[])>0,]
      #subt <- subt[,colSums(subt != 0) > 0]
      ba <- standba(subt)
      alllist <- append(alllist, ba)
    }
    alllist <- alllist[alllist>-555]
    return(mean(alllist))
  }}
  
  
  
  }
  


```


```{r}

balfun <- function(df){
  
  df <- df[order(df$baindi),]
  
  bas <-0
  for(i in 1:nrow(df)){
    bas <- bas + df[i,'baindi']*(i-1)
  }
  
  return(bas)
}

```


```{R}

regionalbal <- function(df){
  
  if(nrow(df)<3){
    return(-999)
  }else{
    if(nrow(df)<=thred){
  
  subtrees <- trees %>%
    filter(plotid %in% unique(df$plotid))
  subtrees <- subtrees %>%
    mutate(
      baindi = (dbh*dbh*tph)/(40000*pi)
    )
  
  plotdf <- subtrees %>%
    dplyr::group_by(plotid)%>%
    dplyr::summarise(
      plotbal = balfun(.)
    )%>%
    ungroup()
  
  return(mean(plotdf$plotbal))
  
    }
    else{
      alllist <- c()
    for (i in 1:10) {
      set.seed(i)
      subt <- df %>%
        sample_n(size = thred)
      
      subtrees <- trees %>%
        filter(plotid %in% unique(subt$plotid))
      subtrees <- subtrees %>%
    mutate(
      baindi = (dbh*dbh*tph)/(40000*pi)
    )
      
      plotdf <- subtrees %>%
        dplyr::group_by(plotid)%>%
        dplyr::summarise(
          plotbal = balfun(.)
        )%>%
        ungroup()
      alllist <- append(alllist, mean(plotdf$plotbal))
    }
      return(mean(alllist))
  }
  }
}



```




### For the following chunk, run one of the two functions depending on the purpose. To eliminate human modification, run the first. To use the full dataset, run the second one. 
```{R}

#subregional <- regionalplt %>%
#  filter(Human_Disturbance < 0.1)

subregional <- regionalplt

```



## Grid level calculation. 

```{R} 
subregional <- subregional %>%
  mutate(indidensity = nindi/meanarea)



gridassociation <- subregional %>%
  #filter(random %in% gridlist[50:55]) %>%
  group_by(random) %>%
  do(data.frame(#association = calcassociation(.),
                associationsimple = calcassociationsimple(.),
                associatoinsimplespear = calcassociationsimplespear(.),
                #assosimplep = assop(.),
                #assospearp = assopspear(.),
                regionalba = regionalba(.),
                #regionalbal = regionalbal(.),
                #associationpartial = calcassociationpartial(.),
                #associationnormpvalue = calcassociationnormpvalue(.),
                associationpvalue = calcassociationpvalue(.),
                #association2 = calcassociation2(.),
                associationsr = associationsr(.),
                #assciationspearsr = associationspearsr(.),
                #associationneg = associationnegprop(.),
                regionalrichness = regionalrichness(.),
                CHELSA_Annual_Mean_Temperature_mean = regionalmean(.,'CHELSA_Annual_Mean_Temperature'),
                #CHELSA_Annual_Mean_Temperature_mean = mean(CHELSA_Annual_Mean_Temperature),
            CHELSA_Annual_Mean_Temperature_std = regionalstd(.,'CHELSA_Annual_Mean_Temperature'),
            CHELSA_Annual_Precipitation_mean = regionalmean(.,'CHELSA_Annual_Precipitation'),
            CHELSA_Annual_Precipitation_std = regionalstd(.,'CHELSA_Annual_Precipitation'),
            CHELSA_Mean_Temperature_of_Coldest_Quarter_mean = regionalmean(.,'CHELSA_Mean_Temperature_of_Coldest_Quarter'),
            CHELSA_Mean_Temperature_of_Coldest_Quarter_std = regionalstd(.,'CHELSA_Mean_Temperature_of_Coldest_Quarter'),
            CHELSA_Precipitation_of_Driest_Quarter_mean = regionalmean(.,'CHELSA_Precipitation_of_Driest_Quarter'),
            CHELSA_Precipitation_of_Driest_Quarter_std = regionalstd(.,'CHELSA_Precipitation_of_Driest_Quarter'),
            CHELSA_Isothermality_mean = regionalmean(.,'CHELSA_Isothermality'),
            CHELSA_Isothermality_std = regionalstd(.,'CHELSA_Isothermality'),
            CHELSA_Precipitation_of_Driest_Quarter_mean = regionalmean(.,'CHELSA_Precipitation_of_Driest_Quarter'),
            CHELSA_Precipitation_of_Driest_Quarter_std = regionalstd(.,'CHELSA_Precipitation_of_Driest_Quarter'),
            CHELSA_Temperature_Annual_Range_mean = regionalmean(.,'CHELSA_Temperature_Annual_Range'),
            CHELSA_Temperature_Annual_Range_std = regionalstd(.,'CHELSA_Temperature_Annual_Range'),
            EarthEnvTopoMed_Elevation_mean = regionalmean(.,'EarthEnvTopoMed_Elevation'),
            EarthEnvTopoMed_Elevation_std = regionalstd(.,'EarthEnvTopoMed_Elevation'),
            EarthEnvTopoMed_Slope_mean = regionalmean(.,'EarthEnvTopoMed_Slope'),
            EarthEnvTopoMed_Slope_std = regionalstd(.,'EarthEnvTopoMed_Slope'),
            EarthEnvTopoMed_Roughness_mean = regionalmean(.,'EarthEnvTopoMed_Roughness'),
            EarthEnvTopoMed_Roughness_std = regionalstd(.,'EarthEnvTopoMed_Roughness'),
            SG_Sand_Content_0_100cm_mean = regionalmean(.,'SG_Sand_Content_0_100cm'),
            SG_Sand_Content_0_100cm_std = regionalstd(.,'SG_Sand_Content_0_100cm'),
            SG_Clay_Content_0_100cm_mean = regionalmean(.,'SG_Clay_Content_0_100cm'),
            SG_Clay_Content_0_100cm_std = regionalstd(.,'SG_Clay_Content_0_100cm'),
            SG_Silt_Content_0_100cm_mean = regionalmean(.,'SG_Silt_Content_0_100cm'),
            SG_Silt_Content_0_100cm_std = regionalstd(.,'SG_Silt_Content_0_100cm'),
            SG_Soil_pH_H2O_0_100cm_mean = regionalmean(.,'SG_Soil_pH_H2O_0_100cm'),
            SG_Soil_pH_H2O_0_100cm_std = regionalstd(.,'SG_Soil_pH_H2O_0_100cm'),
            SG_Absolute_depth_to_bedrock_mean = regionalmean(.,'SG_Absolute_depth_to_bedrock'),
            SG_Absolute_depth_to_bedrock_std = regionalstd(.,'SG_Absolute_depth_to_bedrock'),
            NDVI_mean = regionalmean(.,'NDVI'),
            NDVI_std = regionalstd(.,'NDVI'),
            cnRatio_mean = regionalmean(.,'cnRatio'),
            cnRatio_std = regionalstd(.,'cnRatio'),
            meandensity = regionalmean(.,'indidensity'),
            stddensity = regionalstd(.,'indidensity'),
            HumanFootprint_mean = regionalmean(., 'HumanFootprint'),
            HumanFootprint_std = regionalstd(., 'HumanFootprint'),
            Human_Development_Percentage_mean = regionalmean(.,'Human_Development_Percentage'),
            Human_Development_Percentage_std = regionalstd(.,'Human_Development_Percentage'),
            Human_Disturbance_mean = regionalmean(.,'Human_Disturbance'),
            Human_Disturbance_std = regionalstd(.,'Human_Disturbance')
                #CHELSA_Annual_Mean_Temperature_std = regionalstd(., 'CHELSA_Annual_Mean_Temperature')
                #regionaldensity = regionaldensity(.)
                )) %>%
  #collect()%>%
  ungroup()


gridassociation
```

### Temporarily save the output. 

```{R}

write_csv(regionalplt, '~/Desktop/plot_level_associations_50km_180s_sig_20240404.csv')

```

### Get the grid level coordinate information. 

```{R}

solidplt <- regionalplt %>%
  #filter(associationsimple > -555, regionalrichness > -555 & associationpvalue != -999 & associationsr != -999 ) %>%
  group_by(random) %>%
  summarise(#asso = first(association),
            #assosimple = first(associationsimple),
            #assopvalue = first(associationpvalue),
            #asso2 = first(association2),
            #assosr = first(associationsr),
            #assoneg = first(associationneg),
            #regionalrichness = first(regionalrichness),
            #regionaldensity = first(regionaldensity),
            #assoweight = first(associationweight),
            lon = first(cell_lon),
            lat = first(cell_lat),
            #CHELSA_Annual_Mean_Temperature_mean = mean(CHELSA_Annual_Mean_Temperature),
            #CHELSA_Annual_Mean_Temperature_std = sd(CHELSA_Annual_Mean_Temperature),
            #CHELSA_Annual_Precipitation_mean = mean(CHELSA_Annual_Precipitation),
            #CHELSA_Annual_Precipitation_std = sd(CHELSA_Annual_Precipitation),
            #CHELSA_Mean_Temperature_of_Coldest_Quarter_mean = mean(CHELSA_Mean_Temperature_of_Coldest_Quarter),
            #CHELSA_Mean_Temperature_of_Coldest_Quarter_std = sd(CHELSA_Mean_Temperature_of_Coldest_Quarter),
            #CHELSA_Precipitation_of_Driest_Quarter_mean = mean(CHELSA_Precipitation_of_Driest_Quarter),
            #CHELSA_Precipitation_of_Driest_Quarter_std = sd(CHELSA_Precipitation_of_Driest_Quarter),
            #CHELSA_Isothermality_mean = mean(CHELSA_Isothermality),
            #CHELSA_Isothermality_std = sd(CHELSA_Isothermality),
            #CHELSA_Precipitation_of_Driest_Quarter_mean = mean(CHELSA_Precipitation_of_Driest_Quarter),
            #CHELSA_Precipitation_of_Driest_Quarter_std = sd(CHELSA_Precipitation_of_Driest_Quarter),
            #CHELSA_Temperature_Annual_Range_mean = mean(CHELSA_Temperature_Annual_Range),
            #CHELSA_Temperature_Annual_Range_std = sd(CHELSA_Temperature_Annual_Range),
            #PET_mean = mean(PET),
            #PET_std = sd(PET),
            #EarthEnvTopoMed_Elevation_mean = mean(EarthEnvTopoMed_Elevation),
            
            #EarthEnvTopoMed_Elevation_std = sd(EarthEnvTopoMed_Elevation),
            #EarthEnvTopoMed_Slope_mean = mean(EarthEnvTopoMed_Slope),
            #EarthEnvTopoMed_Slope_std = sd(EarthEnvTopoMed_Slope),
            #EarthEnvTopoMed_Roughness_mean = mean(EarthEnvTopoMed_Roughness),
            #EarthEnvTopoMed_Roughness_std = sd(EarthEnvTopoMed_Roughness),
            #EarthEnvTopoMed_AspectSine_mean = mean(EarthEnvTopoMed_AspectSine),
            #EarthEnvTopoMed_AspectSine_std = sd(EarthEnvTopoMed_AspectSine),
            #EarthEnvTopoMed_AspectCosine_mean = mean(EarthEnvTopoMed_AspectCosine),
            #EarthEnvTopoMed_AspectCosine_std = sd(EarthEnvTopoMed_AspectCosine),
            #EarthEnvTopoMed_Eastness_mean = mean(EarthEnvTopoMed_Eastness),
            #EarthEnvTopoMed_Eastness_std = sd(EarthEnvTopoMed_Eastness),
            #EarthEnvTopoMed_Northness_mean = mean(EarthEnvTopoMed_Northness),
            #EarthEnvTopoMed_Northness_std = sd(EarthEnvTopoMed_Northness),
            #PresentTreeCover_mean = mean(PresentTreeCover),
            #PresentTreeCover_std = sd(PresentTreeCover),
            #CanopyHeight_mean = mean(CanopyHeight),
            #CanopyHeight_std = sd(CanopyHeight),
            #Tree_Density_mean = mean(Tree_Density),
            #Tree_Density_std = sd(Tree_Density),
            #SG_Sand_Content_0_100cm_mean = mean(SG_Sand_Content_0_100cm),
            #SG_Sand_Content_0_100cm_std = sd(SG_Sand_Content_0_100cm),
            #SG_Clay_Content_0_100cm_mean = mean(SG_Clay_Content_0_100cm),
            #SG_Clay_Content_0_100cm_std = sd(SG_Clay_Content_0_100cm),
            #SG_Silt_Content_0_100cm_mean = mean(SG_Silt_Content_0_100cm),
            #SG_Silt_Content_0_100cm_std = sd(SG_Silt_Content_0_100cm),
            #SG_Soil_pH_H2O_0_100cm_mean = mean(SG_Soil_pH_H2O_0_100cm),
            #SG_Soil_pH_H2O_0_100cm_std = sd(SG_Soil_pH_H2O_0_100cm),
            #SG_Absolute_depth_to_bedrock_mean = mean(SG_Absolute_depth_to_bedrock),
            #SG_Absolute_depth_to_bedrock_std = sd(SG_Absolute_depth_to_bedrock),
            #NDVI_mean = mean(NDVI),
            #NDVI_std = sd(NDVI),
            #cnRatio_mean = mean(cnRatio),
            #cnRatio_std = sd(cnRatio),
            WWF_Biome_mode = getmode(WWF_Biome),
            #npp_mean = mean(Npp),
            nplot = n()
            #meandensity = mean(indidensity)
            ) %>%
  ungroup()

#solidplt <- solidplt[complete.cases(solidplt$assosimple),]
solidplt <- solidplt %>%
  filter(nplot>=20)


```


```{R}

solidplt <- solidplt %>%
  left_join(gridassociation, by = 'random')

solidplt

```
```{R}
solidplt <- solidplt %>%
  filter(associationsimple > -555,associationpvalue >=0, regionalrichness > -555  )

```

```{R}

library(maps)

worlddata <- map_data('world')

ggplot() + 
  geom_map(data = worlddata[worlddata$long<(-60) & worlddata$lat>15,], map = worlddata, aes(x = long, y = lat, group = group, map_id = region), fill = '#bcbcbc', color = '#bcbcbc', size = 0.5)+
  geom_point(data = solidplt, aes(x = lon, y = lat, fill = associationsimple), shape = 22, stroke = NA, size = 2)+
  scale_fill_gradientn(colours = c( '#0000FF', '#0074FF',
              '#0DFFEA', '#8CFF41', '#FFDD00',
              '#FF3700', '#C30000'),limits = c(-0.4,0), oob = scales::squish)


ggplot() + 
  geom_map(data = worlddata[worlddata$long<(-60) & worlddata$lat>15,], map = worlddata, aes(x = long, y = lat, group = group, map_id = region), fill = '#bcbcbc', color = '#bcbcbc', size = 0.5)+
  geom_point(data = solidplt, aes(x = lon, y = lat, fill = associatoinsimplespear), shape = 22, stroke = NA, size = 2)+
  scale_fill_gradientn(colours = c( '#0000FF', '#0074FF',
              '#0DFFEA', '#8CFF41', '#FFDD00',
              '#FF3700', '#C30000'),limits = c(-0.7,0), oob = scales::squish)


ggplot() + 
  geom_map(data = worlddata[worlddata$long<(-60) & worlddata$lat>15,], map = worlddata, aes(x = long, y = lat, group = group, map_id = region), fill = '#bcbcbc', color = '#bcbcbc', size = 0.5)+
  geom_point(data = solidplt, aes(x = lon, y = lat, fill = associationpvalue), shape = 22, stroke = NA, size = 2)+
  scale_fill_gradientn(colours = c( '#0000FF', '#0074FF',
              '#0DFFEA', '#8CFF41', '#FFDD00',
              '#FF3700', '#C30000'),limits = c(0,0.05), oob = scales::squish)


ggplot() + 
  geom_map(data = worlddata[worlddata$long<(-60) & worlddata$lat>15,], map = worlddata, aes(x = long, y = lat, group = group, map_id = region), fill = '#bcbcbc', color = '#bcbcbc', size = 0.5)+
  geom_point(data = solidplt[solidplt$associationpvalue<0.05,], aes(x = lon, y = lat, fill = associationsimple), shape = 22, stroke = NA, size = 2)+
  scale_fill_gradientn(colours = c( '#0000FF', '#0074FF',
              '#0DFFEA', '#8CFF41', '#FFDD00',
              '#FF3700', '#C30000'),limits = c(-0.4,0), oob = scales::squish)


```

## Save the final output.

```{R}


solidplt$longitude <- solidplt$lon
solidplt$latitude <- solidplt$lat
solidplt$assosimple <- solidplt$associationsimple
#solidplt$assosimplespear <- solidplt$associatoinsimplespear

write_csv(solidplt, '~/Desktop/grid_level_association_50km_sig_180s_20240404_lowhuman_nocover.csv')


```

